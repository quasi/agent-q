# Canon Fix Plan

**Generated:** 2026-01-21T14:16:14Z
**Canon:** /Users/quasi/quasilabs/projects/agent-q/canon/
**Issues Found:** 12 (4 AUTO, 8 MANUAL)

---

## Summary

| Category | Fixes | Priority |
|----------|-------|----------|
| Infrastructure | 2 | HIGH |
| Context Manifests | 7 | CRITICAL |
| Structure | 4 | MEDIUM |

---

## CRITICAL Fixes

### CRITICAL [AUTO]: Generate Missing Context Manifests

**Issue:** All 7 stable/complete features are missing `.context.yaml` files.

**Features Affected:**
- chat-interface
- context-completion
- context-management
- diff-approval
- file-system-tools
- session-management
- tool-system

**Action:** Run `canon-check --update-context` to automatically generate all context manifests.

**What this does:**
For each feature, the tool will:
1. Read `feature.yaml` to get contract list
2. Extract vocabulary dependencies from contracts
3. Build `essential` paths (vocabulary + contracts + key decisions)
4. Build `per_contract` paths from scenario coverage
5. Build `reference` paths from properties + cross-feature deps
6. Generate `summary` from feature description
7. Estimate token counts from file sizes
8. Write `.context.yaml` to feature directory

**Status:** Will be applied automatically with `--update-context`

---

## HIGH Fixes

### HIGH [AUTO]: Create .canon-meta.yaml

**Issue:** No infrastructure metadata file exists.

**Template:** `canon-bootstrap/templates/canon-meta.yaml.template`

**Substitutions:**
- `{version}` → "0.5.0" (from canon.yaml)
- `{created_with}` → "canon-initiate@0.2.0" (from canon.yaml metadata.initiation.method)
- `{created}` → "2026-01-17T13:00:00Z" (from canon.yaml metadata.initiation.completed)

**Content to create:**
```yaml
infrastructure:
  version: 0.1.0
  created_with: canon-initiate@0.2.0
  last_migrated: null

tracking:
  created: 2026-01-17T13:00:00Z
  last_check: 2026-01-21T14:16:14Z
  last_modified: 2026-01-21T00:00:00Z

checkpoints: []

changelog:
  - date: 2026-01-21
    type: canon-check-first-run
    summary: "Initial health check performed"

  - date: 2026-01-17
    type: canon-created
    created_with: canon-initiate@0.2.0
    method: "Multi-source triangulation (7-pass extraction)"

issues_history:
  - date: 2026-01-21
    check_id: chk-001
    issues_found: 12
    issues_fixed: 0
    plan_file: .canon-check-plan.md
```

**Status:** Will be applied automatically with `--fix`

---

### HIGH [AUTO]: Create README-CANON.md

**Issue:** README-CANON.md not found in Canon root.

**Template:** `canon-bootstrap/templates/README-CANON.md.template`

**Substitutions:**
- `{system-name}` → "Agent-Q" (from canon.yaml metadata.name)
- `{canon-root}` → "/Users/quasi/quasilabs/projects/agent-q/canon/"

**Action:** Copy template and apply substitutions.

**Status:** Will be applied automatically with `--fix`

---

## MEDIUM Fixes

### MEDIUM [MANUAL]: Create feature.yaml for conversation

**Issue:** `features/conversation/feature.yaml` does not exist.

**Action:** Create feature specification based on existing contracts and properties.

**Suggested content:**
```yaml
feature:
  name: conversation
  version: 1.0.0
  status: complete
  confidence: 0.90
  description: |
    Multi-turn conversation management with message history and role tracking.
    Supports system, user, assistant, and debug message roles.

  depends_on:
    core: true

contracts:
  # TODO: List contracts from features/conversation/contracts/

properties:
  # TODO: List properties from features/conversation/properties/

scenarios:
  # TODO: List scenarios if any exist
```

**Reason for MANUAL:** Requires understanding the feature's contracts, properties, and intended API surface.

---

### MEDIUM [MANUAL]: Create feature.yaml for cost-estimation

**Issue:** `features/cost-estimation/feature.yaml` does not exist.

**Canon.yaml notes:** "needs_spec: true", "code_only" triangulation

**Action:** Elevate from plan to formal specification by creating feature.yaml.

**Suggested approach:**
1. Read `src/cost.lisp` to understand implementation
2. Read any existing plans in `specs/plans/`
3. Extract contracts (functions/tools exposed)
4. Document properties (invariants)
5. Create scenarios (usage patterns)

**Reason for MANUAL:** Requires code analysis and design decisions.

---

### MEDIUM [MANUAL]: Create feature.yaml for observability

**Issue:** `features/observability/feature.yaml` does not exist.

**Canon.yaml notes:** "needs_spec: true", "code_only" triangulation

**Action:** Same as cost-estimation (elevate from code to spec).

**Source code:** `src/observability.lisp`

**Reason for MANUAL:** Requires code analysis and design decisions.

---

### MEDIUM [MANUAL]: Create feature.yaml for streaming

**Issue:** `features/streaming/feature.yaml` does not exist.

**Canon.yaml notes:** "needs_spec: true", "code_only" triangulation

**Action:** Same as cost-estimation (elevate from code to spec).

**Source code:** `src/streaming.lisp`

**Existing plan:** `specs/plans/2026-01-13-streaming-observability-upgrade.md`

**Reason for MANUAL:** Requires code analysis and design decisions.

---

## Execution Order

To apply all fixes:

### 1. **Apply AUTO fixes** (can be done now):

```bash
/canon-check --fix              # Creates .canon-meta.yaml and README-CANON.md
/canon-check --update-context   # Generates all 7 .context.yaml files
```

### 2. **Apply MANUAL fixes** (requires your input):

Create feature.yaml for 4 code-only features:
- `conversation` (partial specs exist)
- `cost-estimation` (code-only)
- `observability` (code-only)
- `streaming` (code-only)

**Recommended approach:** Use `/canon-specify` skill to formally specify these features.

---

## After Fixes Applied

Run `/canon-check` again to verify all issues resolved.

Expected outcome:
```
┌─────────────────────────────────────────────────────┐
│ Category              │ Status │ Issues │ Warnings │
├───────────────────────┼────────┼────────┼──────────┤
│ Infrastructure        │   ✓    │   0    │    0     │
│ Structure             │   ⚠    │   0    │    4     │  (feature.yaml optional for code-only)
│ Semantics             │   ✓    │   0    │    0     │
│ Context Manifests     │   ✓    │   0    │    0     │
│ Checkpoints           │   ✓    │   0    │    0     │
│ Staleness             │   ✓    │   0    │    0     │
└─────────────────────────────────────────────────────┘
```

---

## Notes

1. **Context manifests are critical** for Canon skills to work efficiently. They specify exactly what files to load per feature, dramatically reducing token usage.

2. **Infrastructure metadata** enables change tracking, checkpoint discovery, and migration support for future Canon versions.

3. **The 4 code-only features** can remain without feature.yaml if you prefer, but documenting them will improve Canon completeness and enable better verification.

4. **All AUTO fixes are safe** - they create new files from templates without modifying existing code or specs.
