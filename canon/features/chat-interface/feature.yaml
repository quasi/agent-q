# Chat Interface Feature
# Phase: 1-3 (Foundation, Markdown, Sessions)
# Status: Complete
# Confidence: 0.95

feature:
  name: chat-interface
  version: 0.3.0
  status: complete
  confidence: 0.95
  triangulation: convergent
  phase: "1-3"

  description: |
    Interactive chat UI for conversing with the LLM agent. Provides dual-region
    layout (conversation history above, input below), rich markdown rendering with
    syntax highlighting, real-time streaming display, and session integration.

    Developed in three phases: Phase 1 (foundation), Phase 2 (markdown rendering),
    Phase 3 (session management). See ADR-0005 for phased development rationale.

metadata:
  primary_files:
    - contrib/sly-agent-q/sly-agent-q-chat.el  # 800+ lines

  specification:
    - specs/PHASE-1-SPEC.md  # Foundation
    - docs/plans/2026-01-12-chat-context-management.md  # Chat Phase 4
    - canon/core/decisions/0005-phased-chat-development.md  # ADR

  tests:
    file: contrib/sly-agent-q/test/sly-agent-q-chat-test.el
    count: 36
    pass_rate: "100%"
    coverage: "Excellent (all major features tested)"

  dependencies:
    internal:
      - session-management  # Session CRUD operations
      - conversation        # Message history
      - streaming          # Real-time token delivery
      - cost-estimation    # Header cost display
    external:
      - markdown-mode      # Syntax highlighting for code blocks
      - sly               # RPC communication

inventory:
  components:
    - name: "Dual-Region Layout"
      description: "Split buffer: conversation above, input below"
      lines: ~100

    - name: "Message Rendering"
      description: "Displays user/assistant/system messages with markdown"
      lines: ~200

    - name: "Streaming Display"
      description: "Real-time token-by-token rendering"
      lines: ~150

    - name: "Input Management"
      description: "Input history, navigation, send/clear"
      lines: ~100

    - name: "Session Header"
      description: "Displays model, cost, session name"
      lines: ~80

    - name: "Markdown Rendering"
      description: "Code blocks, bold, italic, links"
      lines: ~150

  key_functions:
    - sly-agent-q-chat-mode             # Major mode
    - sly-agent-q-send-message          # Send to agent
    - sly-agent-q-chat-insert-message   # Add message to conversation
    - sly-agent-q-chat--streaming-start # Begin streaming response
    - sly-agent-q-chat--streaming-append # Append token chunk
    - sly-agent-q-chat--update-session-header # Refresh header display

architecture:
  layout:
    description: |
      ┌─────────────────────────────────────────┐
      │ Header: Model | Session | Cost          │
      ├─────────────────────────────────────────┤
      │                                         │
      │ Conversation History                    │
      │ (scrollable, read-only)                 │
      │                                         │
      │ User: Hello                             │
      │ Assistant: Hi! How can I help?          │
      │                                         │
      ├─────────────────────────────────────────┤
      │ Input> [Type message here...]           │
      └─────────────────────────────────────────┘

  regions:
    conversation:
      point_min: 1
      point_max: "conversation marker"
      read_only: true
      purpose: "Display message history"

    input:
      point_min: "input marker"
      point_max: "point-max"
      read_only: false
      purpose: "User types here"

  streaming_flow:
    1_start: "Create placeholder message, position marker"
    2_append: "Insert chunks at marker, advance marker"
    3_finalize: "Apply markdown rendering, finalize message"
    4_error: "Display error message, allow retry"

  markdown_support:
    - "**bold** and *italic*"
    - "`inline code`"
    - "```language ... ``` code blocks with syntax highlighting"
    - "[links](url)"
    - "# Headers"
    - Disabled with: (setq sly-agent-q-chat-markdown-rendering nil)

features_by_phase:
  phase_1_foundation:
    - Dual-region buffer layout
    - Basic message rendering (role + content)
    - Send/clear input commands
    - Input history navigation
    - Message separator lines
    status: complete

  phase_2_markdown:
    - Full markdown support
    - Code block syntax highlighting (via markdown-mode)
    - Diff block rendering
    - Header with model/cost display
    status: complete

  phase_3_sessions:
    - Session creation/switching integration
    - Session header updates (model, cost, name)
    - Auto-save on message send
    - Cost accumulation display
    status: complete

test_coverage:
  buffer_setup: 2  # Layout, session init
  input: 3         # Get, clear, replace
  history: 4       # Add, navigate, no duplicates
  messages: 5      # Render, separators
  streaming: 7     # Start, append, finalize, error, integration
  markdown: 7      # Bold, italic, code, links, blocks, language
  session: 5       # Message creation, timestamps, model, tokens
  header: 3        # Cost display, accumulation, disabled
  total: 36

quality_metrics:
  code_quality: excellent
  test_coverage: excellent (36 tests, 100% passing)
  user_experience: excellent (responsive, real-time feedback)
  markdown_rendering: very_good (full CommonMark subset)
  integration: excellent (sessions, streaming, cost)

known_gaps:
  - "No explicit image rendering (markdown images ignored)"
  - "No table rendering support"
  - "Cost display shows 'N/A' when unavailable (fail-open, see ADR-0004)"
  - "Streaming errors could have better UX (currently just error message)"

related_features:
  - session-management  # CRUD operations, persistence
  - streaming          # Token delivery (ADR-0002)
  - cost-estimation    # Header display (ADR-0004)
  - context-completion # @-mention integration (separate feature)
  - diff-approval      # Results displayed in chat

dependents:
  - "Primary user interface for Agent-Q"
  - "All RPC commands display results here"
