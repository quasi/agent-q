# Cost Estimation Feature
# Extracted from code: src/cost.lisp
# Status: Complete (code-only, now formalized)
# Confidence: 0.75

feature:
  name: cost-estimation
  version: 1.0.0
  status: complete
  confidence: 0.75
  triangulation: code_only
  phase: 3

  description: |
    Pre-flight cost estimation, budget checking, and session cost tracking
    for LLM requests. Integrates with cl-llm-provider's cost API to calculate
    estimated costs before sending requests, enforce budget limits, and track
    actual session spending based on logged token usage.

    Supports "fail-open" design (ADR-0004): when cost estimation is unavailable,
    operations proceed with warnings rather than blocking the agent.

metadata:
  primary_files:
    - src/cost.lisp  # 221 lines

  specification:
    - specs/plans/2026-01-13-streaming-observability-upgrade.md  # Implementation plan

  tests:
    common_lisp: 0
    emacs_lisp: 0
    coverage: "No automated tests"

  dependencies:
    internal:
      - observability  # Reads *request-log* for session cost calculation
    external:
      - cl-llm-provider  # Cost API (estimate-cost, format-cost, model-metadata)

inventory:
  conditions:
    - name: budget-exceeded-error
      type: error
      slots: [:estimated-cost, :budget]
      description: "Signaled when estimated request cost exceeds budget"

  functions:
    estimation:
      - name: estimate-request-cost
        params: [messages, :system-prompt, :max-tokens]
        returns: (values input-cost output-cost total-cost) or (nil nil nil)
        description: "Estimate cost before sending request"

      - name: format-cost-usd
        params: [cost]
        returns: string
        description: "Format cost for display (\"$0.0025\" or \"N/A\")"

      - name: check-budget
        params: [messages, :system-prompt, :max-tokens, :budget]
        returns: t or signals budget-exceeded-error
        description: "Verify request cost within budget, fail-open if unavailable"

    session_tracking:
      - name: get-session-cost
        params: []
        returns: cost-plist
        description: "Calculate total session cost from *request-log*"
        plist: [:input-cost, :output-cost, :total-cost, :input-tokens, :output-tokens, :request-count]

      - name: format-session-cost
        params: [:stream (optional)]
        returns: nil
        description: "Print formatted session cost summary"

architecture:
  cost_estimation_flow:
    1_input: "Messages, system prompt, max-tokens"
    2_provider_query: "cl-llm-provider:estimate-cost"
    3_pricing: "Provider returns input/output/total costs in USD"
    4_nil_handling: "If unavailable, returns (nil nil nil)"

  budget_checking_flow:
    1_estimate: "Call estimate-request-cost"
    2_compare: "Compare total-cost with budget"
    3a_within_budget: "Return t, optionally log to stdout"
    3b_exceeds_budget: "Signal budget-exceeded-error"
    3c_unavailable: "Fail-open: warn and return t (ADR-0004)"

  session_cost_calculation:
    1_aggregate: "Sum prompt-tokens and completion-tokens from *request-log*"
    2_pricing: "Get model metadata for cost-per-1M-tokens"
    3_compute: "Multiply tokens by pricing"
    4_nil_handling: "If pricing unavailable, return tokens but costs=nil"

  fail_open_design:
    principle: "Unavailability of cost data should not block agent operation"
    rationale: "Better to proceed without cost info than fail entirely (ADR-0004)"
    implementation:
      - "estimate-request-cost returns nil when pricing unavailable"
      - "check-budget warns but returns t when estimation fails"
      - "get-session-cost returns token counts even if pricing unavailable"

contracts:
  count: 4
  list:
    - name: pre-flight-cost-estimation
      description: "Estimate cost before request based on message size"
      status: implicit

    - name: budget-enforcement
      description: "Check estimated cost against budget limit"
      status: implicit

    - name: session-cost-tracking
      description: "Calculate total session cost from actual usage"
      status: implicit

    - name: cost-formatting
      description: "Format costs as USD strings for display"
      status: implicit

properties:
  count: 5
  list:
    - name: fail-open-on-unavailability
      description: "Operations succeed with warnings when pricing unavailable (ADR-0004)"
      status: implicit

    - name: usd-pricing
      description: "All costs in USD"
      status: implicit

    - name: actual-usage-tracking
      description: "Session costs based on actual logged tokens, not estimates"
      status: implicit

    - name: per-model-pricing
      description: "Pricing varies by model (from cl-llm-provider metadata)"
      status: implicit

    - name: token-breakdown
      description: "Separate input and output token costs"
      status: implicit

scenarios:
  count: 5
  list:
    - name: estimate-before-request
      description: "Get cost estimate for messages, decide whether to proceed"
      status: implicit

    - name: enforce-budget-limit
      description: "Reject requests exceeding budget threshold"
      status: implicit

    - name: calculate-session-total
      description: "Sum actual session spending after requests complete"
      status: implicit

    - name: fail-open-when-pricing-unavailable
      description: "Proceed with warning when model pricing unknown"
      status: implicit

    - name: format-costs-for-display
      description: "Show costs in chat UI header"
      status: implicit

quality_metrics:
  code_quality: excellent
  test_coverage: none (no automated tests)
  api_design: very_good (clear separation of concerns)
  documentation: excellent (detailed docstrings with examples)
  fail_open_design: excellent (ADR-0004 implemented consistently)

known_gaps:
  - "No formal contracts written"
  - "No formal properties documented"
  - "No formal scenarios"
  - "No automated tests"
  - "No cost forecasting (predict session cost based on history)"
  - "No per-feature cost breakdown"
  - "No cost alerts (warn at X% of budget)"
  - "No cost export (e.g., CSV for billing)"
  - "Session cost assumes 80/20 split when detailed breakdown unavailable"
  - "No cost estimation for streaming requests (uses max-tokens heuristic)"

related_features:
  - observability  # Provides *request-log* for session cost calculation
  - chat-interface  # Displays cost in header

dependencies:
  - feature: observability
    reason: "Reads *request-log* for actual token usage"

  - external: cl-llm-provider
    reason: "Cost API (estimate-cost, model-metadata, format-cost)"

dependents:
  - chat-interface  # Displays session cost in header

design_decisions:
  - decision: "Fail-open design (ADR-0004)"
    rationale: "Cost unavailability shouldn't block agent functionality"
    reference: "core/decisions/0004-fail-open-cost-estimation.md"
    implications:
      - "estimate-request-cost returns nil when pricing unavailable"
      - "check-budget warns but allows request"
      - "get-session-cost returns token counts even without pricing"

  - decision: "Session costs from actual usage, not estimates"
    rationale: "Estimates are inaccurate; use logged actual tokens"
    source: "*request-log* populated by observability hooks"

  - decision: "Separate input/output costs"
    rationale: "Different pricing tiers for input vs output tokens"
    implementation: "Uses model-metadata :input-cost-per-1m-tokens, :output-cost-per-1m-tokens"

  - decision: "Default max-tokens=4096 for estimates"
    rationale: "Conservative upper bound for output length"
    tradeoff: "May over-estimate cost, but prevents surprises"

  - decision: "budget-exceeded-error condition"
    rationale: "Signaling error allows handler-case for custom logic"
    use_case: "UI can catch and prompt user to increase budget"

notes: |
  This feature provides cost transparency and control for Agent-Q's LLM usage.
  It's designed around the "fail-open" principle (ADR-0004): cost estimation
  enhances the UX but doesn't block core functionality.

  **Key capabilities**:
  1. **Pre-flight estimation**: Know costs before sending requests
  2. **Budget enforcement**: Reject expensive requests automatically
  3. **Session tracking**: See cumulative session spending
  4. **Fail-open**: Proceed with warnings when pricing unavailable

  **Integration**:
  - Observability logs actual token usage â†’ enables session cost calculation
  - Chat UI displays session cost in header (updated after each response)
  - Users can set budget limits via check-budget

  **Typical flow**:
  ```
  ;; Pre-flight check
  (check-budget messages :budget 0.50)  ;; Signal error if > $0.50

  ;; After conversation
  (let ((cost-info (get-session-cost)))
    (format t "Session cost: ~A~%"
            (format-cost-usd (getf cost-info :total-cost))))
  ```

  **Fail-open example**:
  ```
  ;; If model pricing unavailable:
  (estimate-request-cost messages)
  ;; => NIL NIL NIL (instead of erroring)

  (check-budget messages :budget 0.10)
  ;; => T (with warning: "Cost estimation unavailable")
  ```

  **Confidence**: 0.75 (code-only, works well but lacks tests and formal spec)
