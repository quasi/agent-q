# Canon Initiation Pass 5: Rationale Recovery
# Project: Agent-Q
# Date: 2026-01-17
# Purpose: Recover design decisions and rationale from git history

recovery:
  completed: 2026-01-17T12:30:00Z
  method: "Git log analysis + commit message archaeology"
  commits_analyzed: 25
  timeframe: "2025-12-01 to 2026-01-17"

# ═══════════════════════════════════════════════════════════════
# ARCHITECTURAL DECISIONS
# ═══════════════════════════════════════════════════════════════

architectural_decisions:
  - decision: "Session management moved from Elisp to Common Lisp"
    commit: 555703e8
    date: "recent (Jan 2026)"
    author: evident from commits
    rationale: |
      Root cause: Agent had its own conversation object, separate from
      the session's conversation. Messages were added to agent's
      conversation but the session's conversation (which gets persisted)
      stayed empty.

      Fix: All functions now check for active session first and use
      the session's conversation when available. This ensures messages
      persist when sessions are saved to disk.
    problem_solved: "Message persistence bug"
    impact: "high"
    decision_type: "bug-driven refactoring"
    confidence: 1.00
    sources:
      - commit: 555703e8
        message: "fix(session): connect agent conversation to session for persistence"
        detail: "Detailed root cause analysis in commit message"

  - decision: "Add streaming support with observability and cost tracking"
    commit: a4a5c66a
    date: "Jan 2026"
    planning_doc: "specs/plans/2026-01-13-streaming-observability-upgrade.md"
    rationale: |
      Three features added together in coordinated plan:
      1. Streaming: Real-time token-by-token display for better UX
      2. Observability: Logging hooks and metrics collection
      3. Cost: Pre-flight estimation and budget checking

      All three integrate with cl-llm-provider's upgraded API.
    problem_solved: "Poor UX with blocking responses, no cost visibility"
    impact: "high"
    decision_type: "planned feature addition"
    confidence: 0.95
    sources:
      - commit: a4a5c66a
        message: "docs(plan): add streaming, observability, and cost API upgrade plan"
      - commit: d9b899d
        message: "feat(agent): implement streaming agent loop with tool support"
      - commit: 9d29909
        message: "feat(observability): add logging hooks and metrics collection"
      - commit: fcb71e3
        message: "feat(cost): add cost estimation and budget checking"

  - decision: "Three-phase chat development (Foundation, Markdown, Sessions)"
    commit: 24c0353f
    date: "Jan 2026"
    rationale: |
      Comprehensive chat interface developed in three phases:
      - Phase 1: Chat foundation (dual regions, history)
      - Phase 2: Rich markdown rendering (code blocks with highlighting)
      - Phase 3: Session management (persistence, caching)

      All delivered in single commit with 38/59 tests passing initially.
    problem_solved: "Basic chat needed upgrade to production quality"
    impact: "very high"
    decision_type: "phased feature rollout"
    confidence: 1.00
    sources:
      - commit: 24c0353f
        message: "Add comprehensive chat interface with session management (Phases 1-3)"
        detail: "Extensive commit message documenting all three phases"

# ═══════════════════════════════════════════════════════════════
# FEATURE DECISIONS
# ═══════════════════════════════════════════════════════════════

feature_decisions:
  - decision: "@-mention auto-trigger completion"
    commit: 6fd5692a
    date: "recent (Jan 2026)"
    rationale: |
      Problem: @-mention required manual M-TAB, poor UX.
      Additionally, buffer context lacked file paths, causing diff
      application failures.

      Solution:
      - Auto-trigger after 2 characters (configurable)
      - Switch to completing-read (works with Helm/Vertico/Ivy)
      - Substring matching instead of prefix
      - Store full file paths in buffer context
      - Include paths in LLM context for accurate diffs
    problem_solved: "Manual completion UX + diff system failures"
    impact: "medium"
    decision_type: "usability improvement + bug fix"
    confidence: 1.00
    sources:
      - commit: 6fd5692a
        message: "fix(@-mention): implement auto-trigger completion and file path tracking"
        tests: "All 99 context tests passing"

  - decision: "Add session header with cost display"
    commit: 232ac23
    date: "Jan 2026"
    rationale: |
      Expose cost information to users in session header.
      Integrates with newly added cost estimation system.
    problem_solved: "Cost transparency for users"
    impact: "low"
    decision_type: "UI enhancement"
    confidence: 0.95
    sources:
      - commit: 232ac23
        message: "feat(chat): add cost display to session header"

  - decision: "Streaming with fallback to synchronous for tool calls"
    commit: d9b899d, 35bcc82
    date: "Jan 2026"
    rationale: |
      Streaming works for text responses but tool calls need
      synchronous handling for reliability.

      Hybrid approach: stream text, fall back to sync for tools.
      Prevent double token counting on fallback.
    problem_solved: "Tool execution reliability with streaming"
    impact: "medium"
    decision_type: "hybrid approach"
    confidence: 0.95
    sources:
      - commit: d9b899d
        message: "feat(agent): implement streaming agent loop with tool support"
      - commit: 35bcc82
        message: "fix(agent): prevent double token counting on tool call fallback"

# ═══════════════════════════════════════════════════════════════
# TECHNICAL DECISIONS
# ═══════════════════════════════════════════════════════════════

technical_decisions:
  - decision: "Model resolution via sync-from-cl-llm-provider"
    commit: 24c0353f
    rationale: |
      Fixed model resolution: sync-from-cl-llm-provider now properly
      populates provider-default-model slot from cl-llm-provider:*default-model*.
      Removed multi-path fallbacks for single canonical behavior.
    problem_solved: "Model name not reported correctly at startup"
    impact: "low"
    decision_type: "bug fix"
    confidence: 1.00
    sources:
      - commit: 24c0353f
        detail: "Part of comprehensive chat interface commit"

  - decision: "Session caching for performance"
    commit: 24c0353f
    rationale: |
      Add session cache (hash table) to avoid repeated disk reads.
      60-second auto-save interval (configurable).
    problem_solved: "Session loading performance"
    impact: "medium"
    decision_type: "performance optimization"
    confidence: 0.95

  - decision: "Defer async calls until after mode setup"
    commit: 23f2819c
    rationale: |
      Bug: Startup message blocked UI.
      Fix: display-config-info now uses run-with-timer to defer
      async call until after mode setup completes.
    problem_solved: "UI blocking on startup"
    impact: "low"
    decision_type: "bug fix"
    confidence: 1.00
    sources:
      - commit: 23f2819c
        message: "fix(chat): resolve streaming display and state management bugs"

  - decision: "DEL key bypasses read-only for pill removal"
    commit: 6fd5692a
    rationale: |
      Context pills are read-only to prevent accidental editing.
      DEL key explicitly bypasses protection for intentional removal.
    problem_solved: "Pill removal UX"
    impact: "low"
    decision_type: "UX refinement"
    confidence: 1.00

# ═══════════════════════════════════════════════════════════════
# TEST STRATEGY DECISIONS
# ═══════════════════════════════════════════════════════════════

test_strategy_decisions:
  - decision: "Elisp-first testing strategy"
    commit: 24c0353f
    rationale: |
      Comprehensive Elisp test suite (38/59 passing initially,
      now 165 tests). Common Lisp tests mentioned but minimal.

      Focus on UI layer where user interaction happens.
    problem_solved: "Test coverage for chat interface"
    impact: "high"
    decision_type: "test strategy"
    confidence: 0.90
    observation: |
      CL tests mentioned in commit but never materialized.
      Suggests UI testing prioritized over backend testing.

  - decision: "Mock SLY functions for CI compatibility"
    commit: 24c0353f
    rationale: |
      Test suite mocks SLY functions to run in batch mode.
      Enables CI without full SLY environment.
    problem_solved: "CI/CD for Elisp tests"
    impact: "medium"
    decision_type: "CI enablement"
    confidence: 0.95

# ═══════════════════════════════════════════════════════════════
# RATIONALE GAPS (Unable to recover)
# ═══════════════════════════════════════════════════════════════

rationale_gaps:
  - question: "Why does :debug message role exist?"
    searched_commits: "all commits mentioning 'debug' or 'message'"
    findings: "No commits explain :debug role addition"
    likely_explanation: "Early development artifact, never removed"
    confidence: 0.60
    recommendation: "Consult original author or remove if unused"

  - question: "Why no automated CL tests?"
    searched_commits: "all commits mentioning 'test'"
    findings: "CL tests mentioned in 24c0353f but never implemented"
    likely_explanation: "UI-first development priority, backend verified via integration"
    confidence: 0.70
    recommendation: "Add CL tests as Phase 4+ work"

  - question: "What is REPL history capacity?"
    searched_commits: "all commits in tools/execution.lisp history"
    findings: "No commit explains capacity value"
    likely_explanation: "Arbitrary constant, not architecturally significant"
    confidence: 0.50
    recommendation: "Document or make configurable"

  - question: "Why is context item type :custom undocumented?"
    searched_commits: "all commits mentioning 'custom' in context"
    findings: "No commits explain :custom type"
    likely_explanation: "Extensibility point for future types"
    confidence: 0.65
    recommendation: "Document intended use cases"

# ═══════════════════════════════════════════════════════════════
# DEVELOPMENT TIMELINE
# ═══════════════════════════════════════════════════════════════

development_timeline:
  phase1_foundation:
    timeframe: "Dec 2025"
    commits:
      - "93d0f76: Add interactive chat interface (Phase 1 Foundation)"
    features: "Basic chat buffer, message rendering"

  phase2_phase3_chat:
    timeframe: "Jan 2026 (early)"
    commits:
      - "24c0353: Add comprehensive chat interface with session management"
    features: "Markdown rendering, session persistence, 38 tests"
    note: "Major milestone commit"

  streaming_observability_cost:
    timeframe: "Jan 2026 (mid)"
    commits:
      - "a4a5c66: docs(plan): streaming, observability, cost plan"
      - "c4b7d85: feat(llm): streaming LLM function"
      - "57e3deb: feat(agent): streaming-callback slot"
      - "7585c5c: feat(streaming): Emacs streaming callbacks"
      - "d9b899d: feat(agent): streaming agent loop with tools"
      - "9d29909: feat(observability): logging hooks"
      - "fcb71e3: feat(cost): cost estimation"
    features: "Streaming, observability, cost tracking"
    note: "Coordinated feature rollout"

  refinement_fixes:
    timeframe: "Jan 2026 (late)"
    commits:
      - "555703e: fix(session): connect agent conversation"
      - "6fd5692: fix(@-mention): auto-trigger completion"
      - "23f2819: fix(chat): streaming display bugs"
    features: "Bug fixes, UX improvements"
    note: "Stabilization phase"

# ═══════════════════════════════════════════════════════════════
# OBSERVATIONS
# ═══════════════════════════════════════════════════════════════

observations:
  - id: obs-rationale-001
    category: recovered
    subject: "Session management architectural fix"
    context: |
      Clear bug-driven refactoring with detailed root cause analysis.
      Agent/session conversation duplication caused persistence bug.
      Fix unified conversation access through session-first approach.
    confidence: 1.00
    quality: "Excellent commit message with root cause + fix"
    affects: ["canon/core/decisions/session-conversation-unification.md"]

  - id: obs-rationale-002
    category: recovered
    subject: "Coordinated streaming/observability/cost rollout"
    context: |
      Three related features added in planned sequence with
      documentation plan preceding implementation commits.
      Shows mature development process.
    confidence: 0.95
    quality: "Planning document + implementation commits"
    affects: ["canon/core/decisions/streaming-architecture.md"]

  - id: obs-rationale-003
    category: gap
    subject: "CL tests never materialized"
    context: |
      Commit 24c0353f mentions CL tests but they don't exist.
      Suggests priority shift to Elisp UI testing.
    confidence: 0.70
    quality: "Gap between stated intent and reality"
    affects: ["canon/features/*/scenarios/ - CL coverage gap"]

  - id: obs-rationale-004
    category: gap
    subject: ":debug role origin unknown"
    context: |
      No commits explain why :debug role exists.
      Not mentioned in specs, possibly early dev artifact.
    confidence: 0.60
    quality: "Rationale lost to history"
    affects: ["canon/core/vocabulary.md#message-role"]

  - id: obs-rationale-005
    category: recovered
    subject: "Hybrid streaming approach (text+sync)"
    context: |
      Streaming works for text, but tool calls need synchronous
      handling. Hybrid approach balances UX with reliability.
      Double token counting bug fixed in follow-up commit.
    confidence: 0.95
    quality: "Clear problem + solution in commits"
    affects: ["canon/core/decisions/streaming-tool-fallback.md"]

# ═══════════════════════════════════════════════════════════════
# SUMMARY
# ═══════════════════════════════════════════════════════════════

summary:
  decisions_recovered: 13
  categories:
    architectural: 3
    feature: 4
    technical: 4
    test_strategy: 2

  rationale_quality:
    excellent: 4  # Detailed commit messages with root cause
    good: 6       # Clear problem + solution
    minimal: 3    # Brief mention only

  gaps_identified: 4
  recovery_success_rate: "76%" # 13 of 17 investigated decisions

  key_findings:
    - "Session conversation unification: Detailed bug analysis in commit"
    - "Streaming/observability/cost: Planned rollout with documentation"
    - "Chat phases: Clear phased development approach"
    - "@-mention auto-trigger: UX-driven improvement with testing"
    - "CL tests: Stated intent never realized, UI testing prioritized"
    - "Hybrid streaming: Pragmatic compromise for reliability"

  commit_message_quality: high
  development_process_indicators:
    - "Planning documents precede implementation"
    - "Bug fixes include root cause analysis"
    - "Feature commits reference issue/problem solved"
    - "Test results documented in commits"
    - "Co-authorship noted (Claude collaboration)"

  next_steps:
    - "Pass 6: Final triangulation with recovered rationale"
    - "Capture key decisions in canon/core/decisions/*.md"
    - "Document gaps for future investigation"
